# ENT-004 â€” Billing & metering: usage records per tenant (tokens, tools, storage) + Stripe integration

- Type: **story**
- Milestone: `M6-ENTERPRISE`
- Repo alignment: **missing**
- Labels: `backend`, `billing`
- Depends on: `P0-003`, `EPIC-ENTERPRISE`

## Problem

Spec includes Stripe-backed billing and quotas. Repo has no billing pipeline and run ledger lacks tenant_id (P0-003).

## Proposed solution

Implement metering:
- Record usage: tokens in/out, tool calls, search requests, storage bytes.
- Aggregate per tenant daily/monthly.
- Integrate Stripe for subscription plans and invoices (minimal).
- Enforce quotas via middleware (reject when exceeded).

## Spec / reference pointers

- reference/NYQST_Platform_Production_Intelligence_Build_Guide_v5.md (Platform Primitive #10)

## Acceptance criteria

- Usage records can be generated and aggregated per tenant.
- Stripe customer + subscription can be linked to tenant.
- Quotas can be configured and enforced.

## Test plan

- Integration: simulate usage; aggregation job produces expected totals.
