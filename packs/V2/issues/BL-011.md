# BL-011 â€” EntityService v0: store all tool outputs as artifacts with stable references

- Type: **story**
- Milestone: `M2-W1`
- Repo alignment: **missing**
- Labels: `backend`, `substrate`, `wave:1`
- Depends on: `BL-003`

## Problem

To support citations and auditability, all tool outputs (search results, fetched pages, extracted tables) must be stored immutably and referenced by hash/id; currently many tool outputs are ephemeral strings.

## Proposed solution

Implement an `EntityService` wrapper around `ArtifactService` + `ManifestService`:
- Provide `store_tool_output(run_id, tool_name, content, media_type, source_url?, meta?) -> entity_ref`
- entity_ref includes `artifact_sha256` and a deterministic `entity_id` (can be same as sha256 in v0)
- Update research tools to store outputs and return refs, not raw blobs.

## Repo touchpoints

- `src/intelli/services/substrate/*`
- `src/intelli/agents/tools/research_tools.py`

## Acceptance criteria

- Calling web search and fetch tools results in stored artifacts in MinIO and DB rows in `artifacts`.
- TaskResult objects reference artifact hashes rather than embedding large blobs.
- UI can fetch and display stored artifacts (existing artifact viewer).

## Test plan

- Integration: tool output stored and retrievable by sha256; manifest references increment reference_count.
