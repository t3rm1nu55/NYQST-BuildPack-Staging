# User flows master (deep)

This document is intentionally redundant. Agents should be able to implement a feature by:
- finding the flow
- reading the acceptance criteria
- implementing the contract
- wiring UI + API + tests

---

## Flow 0 — Create project → first intelligence output (the “golden path”)

Goal: prove the whole system is real.

0. Entry: user lands on Projects list.
1. Create Project
   1.1 Click “New project”
   1.2 Enter name, optional description
   1.3 System creates project + default permissions (owner)
   1.4 Redirect to Project Home

2. Upload first bundle (documents)
   2.1 From Project Home, click “Upload bundle”
   2.2 Provide bundle metadata:
       - bundle name
       - bundle type (lease pack / vendor pack / regulatory pack / research pack)
       - tags
   2.3 Upload files (PDF/DOCX/HTML/CSV) OR connect to source (later)
   2.4 System creates Bundle + Version v1
   2.5 Ingest pipeline runs:
       - store raw artifacts
       - extract text
       - normalize
       - chunk/index (RAG)
       - extraction (structured)
   2.6 User sees processing status streaming in UI

3. Run an App (Dify-style)
   3.1 Go to Apps
   3.2 Choose template app “Lease Review” (or “Research Notebook”)
   3.3 Run tab shows inputs:
       - Bundle (default: newly uploaded)
       - Focus questions (optional)
   3.4 Context toggles:
       - include project context (on)
       - include bundle v1 (on)
       - include web (optional)
   3.5 Click Run
   3.6 System streams:
       - plan creation
       - progress events
       - partial outputs
       - sources/evidence captured
   3.7 Run completes, outputs appear:
       - notebook page created
       - evidence items created
       - insights created (optional)

4. Pin output into Studio
   4.1 From app output preview, click “Pin to canvas”
   4.2 Canvas opens with:
       - App Output block (linked to run id)
       - Evidence blocks created for key sources
       - Edges: “derived-from”
   4.3 Notebook has new page with sections + citations

5. Review and promote
   5.1 User opens Evidence panel
   5.2 Verifies key evidence is correct
   5.3 Converts evidence → insight
   5.4 Links insight to CRM entity or model field

Acceptance criteria:
- User can do the above without any manual data plumbing.
- Every artifact on screen has a provenance path:
  (bundle version → ingest run → extraction/evidence → insight → app run → output block)

Test coverage:
- E2E: Playwright golden path.
- Integration: bundle upload + ingest run + event stream.
- Contract: app run event payloads and artifact linkage.

---

## Flow 1 — Bundle ingest, versioning, and diff (NotebookLM-grade)

### 1.1 Upload bundle (v1)

Entry points:
- Documents → Upload
- Project Home → Upload
- CRM entity → Attach docs

Steps:
1) Create bundle metadata
2) Upload files
3) Create Version v1 and start ingest pipeline
4) Show processing and allow navigation away
5) When complete:
   - extracted text preview
   - extracted structured fields
   - evidence highlights
   - “create app from this bundle” CTA

Edge cases:
- partial extraction: show warnings with retry
- unsupported file type: reject with clear message
- duplicate file: dedupe with hash + show as already present
- large file: background ingestion; show ETA class (“minutes”)
- user closes browser: processing continues; progress visible in run history

### 1.2 Create new version (v2)

User intent:
- replace a file
- add new docs
- update data

Steps:
1) Open bundle detail
2) Click “New version”
3) Upload changed/new files
4) System creates Version v2
5) Runs ingest pipeline again
6) When complete: show “What changed?” entry point

### 1.3 Compare versions (diff)

Compare surfaces (must exist):
- Document diff: text/structure changes
- Extraction diff: structured fields delta
- Model impact diff: what model values changed because extraction changed

UX requirements:
- left/right columns with v1/v2
- inline highlights
- toggle per diff type
- show confidence changes and extraction quality deltas
- ability to “pin diff” to canvas as a block

Acceptance criteria:
- For a changed bundle version, the user can see:
  “what changed” and “why it matters” and “what downstream changed”.

Tests:
- Unit: diff algorithms on text and structured JSON
- Integration: ingest pipeline produces deterministic extraction on fixed fixtures
- E2E: upload v1 + v2 and verify UI shows deltas

---

## Flow 2 — Evidence and insights lifecycle (audit-first)

### 2.1 Evidence creation

Evidence is generated by:
- extraction pipeline (field values with source spans)
- agent/app runs (citations, web sources)
- user manual clipping from docs/notebook/canvas

Evidence must have:
- source: bundle version + page/offset OR web URL + snapshot
- content: snippet or extracted value
- confidence: number + explanation
- created_by: user/system/app
- run_id linkage (if created by system)

### 2.2 Evidence review queue

A view (can be a View App):
- low confidence evidence
- evidence with missing provenance
- evidence with conflicting claims

Actions:
- approve
- edit (creates new evidence version)
- mark conflict
- link to insight/model field

### 2.3 Insights

Insight is a claim that:
- references evidence items
- can be linked to CRM entity and/or model field
- has status: draft → reviewed → published

Insight diff:
- if evidence changes due to bundle version v2, insight shows “stale” indicator and suggests re-validation

Acceptance criteria:
- “No orphan claims”: every insight links to at least one evidence.
- stale indicator triggers on upstream changes.

Tests:
- Unit: stale computation (dependency graph)
- Integration: evidence → insight → model linkage persisted
- E2E: create insight from evidence, then change bundle version, see stale badge

---

## Flow 3 — Apps (configured units of work)

Apps package repeatable work. They are the primary unit for:
- “Run it again next week”
- “Run it for every new bundle version”
- “Share the workflow with the team”

### 3.1 Create app (template)

1) Apps → Create
2) Choose template:
   - Research Notebook
   - Lease Review
   - Vendor Due Diligence
   - Weekly Refresh
3) Configure:
   - inputs schema
   - context pack defaults
   - engine selection (agent/workflow/view)
   - outputs mapping
4) Save as Draft
5) Publish (creates version 1)

### 3.2 Run app

1) Run tab
2) Fill inputs
3) Confirm context toggles
4) Run now
5) Streaming output:
   - plan/task events
   - preview deltas
   - sources found
6) Promote output:
   - pin to canvas
   - create insight
   - update model field (if allowed)

### 3.3 App versioning + diff

Rules:
- Published versions immutable.
- Editing creates draft vNext.
- Runs reference exact version.

Diff surfaces:
- input schema diff
- context pack diff
- engine config diff
- output mapping diff

Acceptance criteria:
- user can see what changed between app v1 and v2
- can re-run old version for audit or comparison

---

## Flow 4 — Studio (Notebook + Canvas)

### 4.1 Notebook writing with sources

- Notebook blocks support:
  - citations and evidence embedding
  - “ask” interactions (“summarize from these sources”)
  - traceability to runs and bundle versions

Minimum v1:
- pages list
- block types: text, evidence embed, app output embed, chart embed
- citations panel

### 4.2 Canvas analysis

Canvas supports:
- pan/zoom
- blocks and edges
- inspector panel
- block search
- pinning outputs/diffs

Minimum v1:
- blocks: app output, evidence, insight, bundle version, diff, model field
- edges: derived-from, supports, contradicts
- inspector with provenance and run links

### 4.3 Diff overlays on canvas

User can:
- select bundle version v1 and v2
- overlay changes:
  - changed evidence
  - stale insights
  - changed model fields
- pin overlay as a “Diff block” and share

---

## Flow 5 — Models + validation

### 5.1 Create model definition

Models represent domain schemas:
- fields
- expected evidence requirements
- rules

Model definitions are versioned.

### 5.2 Validation run

Validation is executed:
- manually
- scheduled
- triggered by new bundle version / extraction changes

Outputs:
- pass/fail by rule
- changed fields
- evidence coverage gaps

### 5.3 Model impact diff

When upstream documents change, compute:
- which model fields changed
- why (evidence deltas)
- which dashboards impacted

Acceptance criteria:
- dashboards never silently change: every delta is explainable

---

## Flow 6 — Workflows (n8n-like)

Workflow is a graph of nodes with triggers.

Minimum v1:
- templates and runner
- a few node types:
  - trigger: schedule, new bundle version
  - action: run app, run extraction, run validation, notify
  - condition: if validation fails
- run logs per node
- retries and partial success

---

## Flow 7 — Run logs and audit (non-negotiable)

Every compute action generates a Run with:
- who started it (user/system)
- what it ran (app/workflow/pipeline)
- inputs + context pack version
- streaming events timeline
- artifacts produced
- cost/tokens/duration
- errors and retries

UI:
- Run detail page shows timeline, artifacts, sources, and replay-able prompts (later).

